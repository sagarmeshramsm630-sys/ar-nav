<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Web AR Navigation — Fixed</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    :root { color-scheme: light dark; }
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; }
    #hud { position: fixed; top: env(safe-area-inset-top, 12px); left: 12px; right: 12px; z-index: 10; display:flex; gap:8px; align-items:center; background: color-mix(in oklab, Canvas 85%, transparent); backdrop-filter: blur(8px); border: 1px solid color-mix(in oklab, CanvasText 20%, transparent); border-radius: 14px; padding: 10px 12px; box-shadow: 0 4px 16px rgba(0,0,0,.1); }
    #status { font-weight: 600; font-size: 14px; }
    #controls { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    #controls input { width: 9rem; padding:.5rem .6rem; border-radius: 10px; border:1px solid color-mix(in oklab, CanvasText 25%, transparent); background: color-mix(in oklab, Canvas 90%, transparent); }
    #controls button { padding:.55rem .8rem; border-radius: 10px; border:1px solid color-mix(in oklab, CanvasText 25%, transparent); background: color-mix(in oklab, AccentColor 20%, Canvas 85%); font-weight:600; }
    #map { position: absolute; inset:0; display:none; }
    #permit { position: fixed; bottom: env(safe-area-inset-bottom, 12px); left: 12px; right: 12px; z-index: 10; text-align:center; font-size: 12px; opacity:.8; }
    canvas { display:block; width:100%; height:100%; }
  </style>
</head>
<body>
  <div id="hud">
    <div id="status">Initializing…</div>
    <div id="controls">
      <label style="font-size:12px; opacity:.7">Dest lat</label><input id="destLat" type="number" step="any" placeholder="e.g. 37.7754" />
      <label style="font-size:12px; opacity:.7">Dest lon</label><input id="destLon" type="number" step="any" placeholder="e.g. -122.4180" />
      <button id="btnRoute" title="Fetch route">Get route</button>
    </div>
  </div>
  <div id="map"></div>
  <div id="permit">Use outdoors. Requires motion+location permissions and HTTPS. If AR isn’t available, a live 2D map fallback will appear.</div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
    import { ARButton } from 'https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js';

    const MAPBOX_TOKEN = 'REPLACE_WITH_YOUR_MAPBOX_TOKEN';
    const ORS_API_KEY = 'REPLACE_WITH_YOUR_ORS_API_KEY';

    const R = 6378137;
    function ll2enu(lat, lon, lat0, lon0){
      const dLat = (lat - lat0) * Math.PI/180;
      const dLon = (lon - lon0) * Math.PI/180;
      const x = R * dLon * Math.cos(((lat+lat0)*0.5) * Math.PI/180);
      const z = -R * dLat;
      return { x, z };
    }
    function haversine(a, b){
      const dLat = (b.lat-a.lat)*Math.PI/180;
      const dLon = (b.lon-a.lon)*Math.PI/180;
      const la1 = a.lat*Math.PI/180, la2 = b.lat*Math.PI/180;
      const h = Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.min(1, Math.sqrt(h)));
    }

    const state = {
      hasXR: false,
      renderer: null, scene: null, camera: null,
      guides: null, distanceBoard: null,
      originLLA: null, currentLLA: null,
      routeLLA: [], nextIdx: 0,
      map: null, watchId: null
    };

    const ui = {
      status: document.getElementById('status'),
      mapEl: document.getElementById('map'),
      destLat: document.getElementById('destLat'),
      destLon: document.getElementById('destLon'),
      btnRoute: document.getElementById('btnRoute')
    };

    async function detectXR(){
      if (navigator.xr && navigator.xr.isSessionSupported){
        state.hasXR = await navigator.xr.isSessionSupported('immersive-ar');
      }
    }

    function createChevronStrip(count = 10, spacing = 0.9){
      const group = new THREE.Group();
      const shape = new THREE.Shape();
      shape.moveTo(-0.35, 0);
      shape.lineTo(0, 0.35);
      shape.lineTo(0.35, 0);
      shape.lineTo(0, -0.35);
      shape.lineTo(-0.35, 0);
      const geo = new THREE.ExtrudeGeometry(shape, { depth: 0.02, bevelEnabled: false });
      const mat = new THREE.MeshStandardMaterial({ color: 0x2eea5a, emissive: 0x0b5d1d, emissiveIntensity: 0.85 });
      for (let i = 0; i < count; i++){
        const m = new THREE.Mesh(geo, mat);
        m.rotation.x = -Math.PI / 2;
        m.position.z = -1.2 - i * spacing;
        m.position.y = -0.18 + i * 0.01;
        const s = 1.0 - i * 0.05;
        m.scale.set(s, s, 1);
        group.add(m);
      }
      return group;
    }

    function createDistanceBoard(){
      const canvas = document.createElement('canvas');
      canvas.width = 512; canvas.height = 256;
      const ctx = canvas.getContext('2d');
      const texture = new THREE.CanvasTexture(canvas);
      const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true });
      const geometry = new THREE.PlaneGeometry(0.9, 0.45);
      const mesh = new THREE.Mesh(geometry, material);
      mesh.userData.draw = (txt) => {
        ctx.clearRect(0,0,512,256);
        ctx.fillStyle = 'rgba(0,0,0,0.55)';
        ctx.fillRect(0,0,512,256);
        ctx.fillStyle = 'white';
        ctx.font = 'bold 48px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(txt, 256, 128);
        texture.needsUpdate = true;
      };
      return mesh;
    }

    function initThree(){
      state.renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      state.renderer.setSize(innerWidth, innerHeight);
      state.renderer.xr.enabled = true;
      document.body.appendChild(state.renderer.domElement);
      state.scene = new THREE.Scene();
      state.camera = new THREE.PerspectiveCamera();
      const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
      state.scene.add(light);
      const chevrons = createChevronStrip();
      chevrons.position.set(0, -0.2, -1.5);
      state.scene.add(chevrons);
      state.guides = chevrons;
      const board = createDistanceBoard();
      board.position.set(0, 0.15, -1.0);
      state.scene.add(board);
      state.distanceBoard = board;
      const btn = ARButton.createButton(state.renderer);
      document.body.appendChild(btn);
      state.renderer.setAnimationLoop(onXRFrame);
    }

    function onXRFrame(){
      if (!state.currentLLA || state.routeLLA.length === 0){
        state.renderer.render(state.scene, state.camera);
        return;
      }
      const target = state.routeLLA[Math.min(state.nextIdx, state.routeLLA.length-1)];
      const enu = ll2enu(target.lat, target.lon, state.currentLLA.lat, state.currentLLA.lon);
      const targetVec = new THREE.Vector3(enu.x, 0, enu.z).applyMatrix4(state.camera.matrixWorldInverse);
      const yaw = Math.atan2(-targetVec.x, targetVec.z);
      state.guides.rotation.set(0, 0, yaw);
      state.renderer.render(state.scene, state.camera);
    }

    navigator.geolocation.watchPosition(p => {
      state.currentLLA = { lat: p.coords.latitude, lon: p.coords.longitude };
      if (!state.originLLA) state.originLLA = { ...state.currentLLA };
    });

    detectXR().then(() => { if (state.hasXR) initThree(); else ui.status.textContent = 'AR not supported'; });
  </script>
</body>
</html>
