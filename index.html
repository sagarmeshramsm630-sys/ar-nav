<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR Indoor Navigation</title>
    <!-- A-Frame and AR.js Libraries -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.1/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        /* Custom CSS for the overlay UI and overall aesthetics */
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        
        /* The AR scene will take up the entire viewport */
        #ar-scene {
            width: 100vw;
            height: 100vh;
        }

        /* UI Overlay for the "Clear Navigation" button */
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1rem;
            box-sizing: border-box;
            pointer-events: none; /* Allows clicks to fall through unless on a button */
            z-index: 10;
            display: flex;
            justify-content: flex-end;
        }

        .ar-button {
            pointer-events: auto; /* Re-enable pointer events for the button */
            background-color: rgba(34, 197, 94, 0.8); /* Semi-transparent Green */
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s, transform 0.1s;
        }

        .ar-button:hover {
            background-color: rgba(5, 150, 105, 0.9);
        }

        .ar-button:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>

    <!--
        A-Frame Component: Flow Path Animation
        This component continuously moves a set of arrows back along the Z-axis
        and resets their position when they pass a certain point, creating a flowing effect.
    -->
    <script>
        AFRAME.registerComponent('flow-path', {
            schema: {
                speed: {type: 'number', default: 0.2}, // Units per second
                resetDistance: {type: 'number', default: 15}, // Distance after which an arrow resets
                count: {type: 'number', default: 15} // Number of arrows
            },
            init: function () {
                this.arrows = [];
                // Find all child arrow entities
                for (let i = 0; i < this.data.count; i++) {
                    const arrow = this.el.querySelector(`#arrow-${i}`);
                    if (arrow) {
                        this.arrows.push(arrow);
                    }
                }
                this.lastTime = performance.now();
                this.active = true; // State to control animation
            },
            
            tick: function (time, deltaTime) {
                if (!this.active) return;
                
                const deltaSeconds = deltaTime / 1000;
                const distanceToMove = this.data.speed * deltaSeconds;
                
                // Move and check reset condition for each arrow
                this.arrows.forEach(arrow => {
                    const pos = arrow.object3D.position;
                    
                    // Move the arrow backward (negative Z)
                    pos.z -= distanceToMove;

                    // If the arrow passes the reset distance, snap it back to the start
                    // The path is 15 units long, so reset at z < -0.5
                    if (pos.z < -0.5) {
                        // Reset to the position of the last arrow + a gap
                        pos.z += this.data.resetDistance; 
                    }
                });
            },

            // Public method to stop the flow
            stopFlow: function() {
                this.active = false;
                console.log('Path flow stopped.');
            },

            // Public method to resume the flow
            startFlow: function() {
                this.active = true;
                this.lastTime = performance.now(); // Reset last time for smoother start
                console.log('Path flow started.');
            }
        });

        // Function linked to the "Clear Navigation" button
        function clearNavigation() {
            const pathEntity = document.querySelector('#navigation-path');
            if (pathEntity) {
                const flowComponent = pathEntity.components['flow-path'];
                if (flowComponent) {
                    flowComponent.stopFlow();
                    // Optionally hide the entire path entity
                    pathEntity.setAttribute('visible', false);
                    
                    // You could also change the button text to 'Resume Navigation'
                    const button = document.querySelector('#clear-nav-button');
                    button.textContent = 'Navigation Cleared';
                    button.disabled = true;
                }
            }
        }
    </script>


    <!-- UI Overlay for the button -->
    <div id="ui-overlay">
        <button id="clear-nav-button" class="ar-button" onclick="clearNavigation()">
            Clear Navigation
        </button>
    </div>

    <!-- A-Frame Scene Setup -->
    <!-- arjs properties:
        trackingMethod: best - Uses the best available tracking (usually based on gyroscope and feature tracking).
        sourceType: webcam - Uses the device camera.
        debugUIEnabled: false - Hides the AR.js debug overlay.
    -->
    <a-scene 
        id="ar-scene"
        vr-mode-ui="enabled: false"
        arjs='sourceType: webcam; trackingMethod: best; debugUIEnabled: false;'
        renderer="logarithmicDepthBuffer: true;">

        <!--
            The Path Container
            The 'flow-path' component is attached here to control all the child arrows.
        -->
        <a-entity id="navigation-path" flow-path="count: 15; speed: 1.5; resetDistance: 15">
            <!--
                Arrow Geometry Definition
                This is a simple triangle shape to represent the arrow head.
            -->
            <a-mixin id="arrow-shape"
                     geometry="primitive: circle; segments: 3; radius: 0.15"
                     rotation="90 0 0"
                     material="color: #00FFFF; opacity: 0.7; metalness: 0.5; roughness: 0.5; emissive: #00FFFF; emissiveIntensity: 1.5"
                     ></a-mixin>

            <!--
                Path Generation
                We create 15 arrows spaced 1 unit apart along the Z-axis.
                The flow-path component will continuously animate these.
            -->
            <a-entity mixin="arrow-shape" id="arrow-0" position="0 0.05 14"></a-entity>
            <a-entity mixin="arrow-shape" id="arrow-1" position="0 0.05 13"></a-entity>
            <a-entity mixin="arrow-shape" id="arrow-2" position="0 0.05 12"></a-entity>
            <a-entity mixin="arrow-shape" id="arrow-3" position="0 0.05 11"></a-entity>
            <a-entity mixin="arrow-shape" id="arrow-4" position="0 0.05 10"></a-entity>
            <a-entity mixin="arrow-shape" id="arrow-5" position="0 0.05 9"></a-entity>
            <a-entity mixin="arrow-shape" id="arrow-6" position="0 0.05 8"></a-entity>
            <a-entity mixin="arrow-shape" id="arrow-7" position="0 0.05 7"></a-entity>
            <a-entity mixin="arrow-shape" id="arrow-8" position="0 0.05 6"></a-entity>
            <a-entity mixin="arrow-shape" id="arrow-9" position="0 0.05 5"></a-entity>
            <a-entity mixin="arrow-shape" id="arrow-10" position="0 0.05 4"></a-entity>
            <a-entity mixin="arrow-shape" id="arrow-11" position="0 0.05 3"></a-entity>
            <a-entity mixin="arrow-shape" id="arrow-12" position="0 0.05 2"></a-entity>
            <a-entity mixin="arrow-shape" id="arrow-13" position="0 0.05 1"></a-entity>
            <a-entity mixin="arrow-shape" id="arrow-14" position="0 0.05 0"></a-entity>

            <!-- A simple line to show the path's central spine -->
            <a-entity line="start: 0 0.01 0; end: 0 0.01 15; color: #00FFFF; opacity: 0.3"></a-entity>
        </a-entity>

        <!-- The camera element must be defined for AR.js to work correctly -->
        <a-camera gps-new-camera="gpsMinAccuracy: 5"></a-camera>

    </a-scene>

</body>
</html>